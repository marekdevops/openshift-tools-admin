#!/bin/bash
#
# ocp-activate - Aktywacja ≈õrodowiska OpenShift (styl venv)
#
# U≈ºycie: source ocp-activate [klaster]
#         source ocp-activate           # aktywuj bez wyboru klastra
#         source ocp-activate prod1     # aktywuj i prze≈ÇƒÖcz na prod1
#
# Dezaktywacja: ocp-deactivate
#

# Sprawd≈∫ czy skrypt jest source'owany
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    echo "Ten skrypt musi byƒá uruchomiony przez 'source':"
    echo "  source ocp-activate"
    echo "  source ocp-activate [nazwa-klastra]"
    exit 1
fi

# Zapisz oryginalne warto≈õci do przywr√≥cenia
export _OCP_OLD_PS1="${PS1:-}"
export _OCP_OLD_PATH="${PATH:-}"
export _OCP_OLD_KUBECONFIG="${KUBECONFIG:-}"
export _OCP_ACTIVE=1

# ============================================
# ≈öCIE≈ªKI
# ============================================

export OCP_TOOLS_DIR="${OCP_TOOLS_DIR:-$HOME/.local/share/openshift-tools}"
export KUBE_CLUSTERS_DIR="$HOME/.kube/clusters"
export KUBE_TOKENS_DIR="$HOME/.kube/tokens"

# Dodaj do PATH
export PATH="$HOME/.local/bin:$OCP_TOOLS_DIR/bin:$PATH"

# ============================================
# ALIASY
# ============================================

# Prze≈ÇƒÖczanie klastr√≥w - dostosuj do swoich!
alias kprod1='export KUBECONFIG=$KUBE_CLUSTERS_DIR/prod-cluster1 && echo "üî¥ PRODUKCJA 1"'
alias kprod2='export KUBECONFIG=$KUBE_CLUSTERS_DIR/prod-cluster2 && echo "üî¥ PRODUKCJA 2"'
alias kstg='export KUBECONFIG=$KUBE_CLUSTERS_DIR/staging-cluster && echo "üü° STAGING"'
alias kdev='export KUBECONFIG=$KUBE_CLUSTERS_DIR/dev-cluster && echo "üü¢ DEV"'
alias ktest='export KUBECONFIG=$KUBE_CLUSTERS_DIR/test-cluster && echo "üîµ TEST"'
alias kreset='unset KUBECONFIG && echo "KUBECONFIG reset"'

# Komendy oc
alias k='oc'
alias kgp='oc get pods'
alias kgs='oc get services'
alias kgd='oc get deployments'
alias kgn='oc get nodes'
alias kgns='oc get projects'
alias kns='oc project'
alias kl='oc logs'
alias klf='oc logs -f'
alias kexec='oc exec -it'
alias ka='oc apply -f'
alias kinfo='echo "=== Cluster ===" && oc whoami --show-server && echo "=== User ===" && oc whoami && echo "=== Project ===" && oc project -q'

# ============================================
# PROMPT Z KONTEKSTEM KUBERNETES
# ============================================

__ocp_prompt() {
    local ctx=""
    local ns=""
    local color_start=""
    local color_end=$'\001\033[0m\002'

    if [[ -n "$KUBECONFIG" && -f "$KUBECONFIG" ]]; then
        ctx=$(basename "$KUBECONFIG" 2>/dev/null)
        ns=$(oc project -q 2>/dev/null || echo "?")

        # Kolory wed≈Çug typu ≈õrodowiska
        case "$ctx" in
            *prod*)  color_start=$'\001\033[0;31m\002' ;;  # czerwony
            *stag*)  color_start=$'\001\033[0;33m\002' ;;  # ≈º√≥≈Çty
            *dev*)   color_start=$'\001\033[0;32m\002' ;;  # zielony
            *test*)  color_start=$'\001\033[0;34m\002' ;;  # niebieski
            *)       color_start=$'\001\033[0;35m\002' ;;  # fioletowy
        esac

        echo "${color_start}[${ctx}/${ns}]${color_end} "
    else
        echo $'\001\033[0;36m\002'"(ocp)"$'\001\033[0m\002'" "
    fi
}

# Ustaw nowy prompt
PS1='$(__ocp_prompt)'"${_OCP_OLD_PS1}"

# ============================================
# FUNKCJA DEZAKTYWACJI
# ============================================

ocp-deactivate() {
    # Przywr√≥ƒá oryginalne warto≈õci
    if [[ -n "$_OCP_OLD_PS1" ]]; then
        PS1="$_OCP_OLD_PS1"
    fi

    if [[ -n "$_OCP_OLD_PATH" ]]; then
        PATH="$_OCP_OLD_PATH"
    fi

    if [[ -n "$_OCP_OLD_KUBECONFIG" ]]; then
        KUBECONFIG="$_OCP_OLD_KUBECONFIG"
    else
        unset KUBECONFIG
    fi

    # Usu≈Ñ aliasy
    unalias kprod1 kprod2 kstg kdev ktest kreset 2>/dev/null
    unalias k kgp kgs kgd kgn kgns kns kl klf kexec ka kinfo 2>/dev/null

    # Wyczy≈õƒá zmienne
    unset _OCP_OLD_PS1 _OCP_OLD_PATH _OCP_OLD_KUBECONFIG _OCP_ACTIVE
    unset OCP_TOOLS_DIR KUBE_CLUSTERS_DIR KUBE_TOKENS_DIR
    unset -f ocp-deactivate __ocp_prompt ocp-current ocp-list ocp ocp-check __check_token_validity 2>/dev/null

    echo "≈örodowisko OCP dezaktywowane"
}

# ============================================
# WALIDACJA TOKENU (uproszczona dla funkcji)
# ============================================

__check_token_validity() {
    local kubeconfig_file="$1"

    if [[ ! -f "$kubeconfig_file" ]]; then
        echo "missing"
        return
    fi

    local token=$(grep "token:" "$kubeconfig_file" 2>/dev/null | head -1 | awk '{print $2}')

    if [[ -z "$token" ]]; then
        echo "no-token"
        return
    fi

    # Sprawd≈∫ JWT expiration
    if [[ "$token" =~ ^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$ ]]; then
        local payload=$(echo "$token" | cut -d. -f2 | base64 -d 2>/dev/null)
        local exp=$(echo "$payload" | grep -o '"exp":[0-9]*' 2>/dev/null | cut -d: -f2)

        if [[ -n "$exp" ]]; then
            local now=$(date +%s)
            if [[ $exp -lt $now ]]; then
                echo "expired"
                return
            fi
        fi
    fi

    echo "valid"
}

# ============================================
# FUNKCJE POMOCNICZE
# ============================================

ocp-current() {
    if [[ -z "$KUBECONFIG" ]]; then
        echo -e "\033[0;31mBrak aktywnego klastra (KUBECONFIG nie ustawiony)\033[0m"
        echo -e "\033[0;33mUWAGA: Komendy oc/kubectl u≈ºyjƒÖ ~/.kube/config!\033[0m"
        return 1
    fi

    local cluster_name=$(basename "$KUBECONFIG")
    local token_status=$(__check_token_validity "$KUBECONFIG")

    echo "Klaster:  $cluster_name"

    # Status tokenu
    case "$token_status" in
        valid)    echo -e "Token:    \033[0;32maktywny\033[0m" ;;
        expired)  echo -e "Token:    \033[0;31mWYGAS≈Å\033[0m - u≈ºyj: ocp-login $cluster_name" ;;
        no-token) echo -e "Token:    \033[0;33mbrak tokenu\033[0m" ;;
        missing)  echo -e "Token:    \033[0;31mbrak pliku\033[0m" ;;
        *)        echo -e "Token:    \033[0;90mnieznany\033[0m" ;;
    esac

    local user=$(oc whoami 2>/dev/null)
    if [[ -n "$user" ]]; then
        echo -e "User:     \033[0;32m$user\033[0m"
        echo "Project:  $(oc project -q 2>/dev/null || echo 'brak')"
        echo "API:      $(oc whoami --show-server 2>/dev/null)"
    else
        echo -e "User:     \033[0;31mnie po≈ÇƒÖczony\033[0m"
        local api=$(grep "server:" "$KUBECONFIG" 2>/dev/null | head -1 | awk '{print $2}')
        echo "API:      $api (z kubeconfig)"
    fi
}

ocp-list() {
    echo "Dostƒôpne klastry:"

    if [[ ! -d "$KUBE_CLUSTERS_DIR" ]] || [[ -z "$(ls -A "$KUBE_CLUSTERS_DIR" 2>/dev/null)" ]]; then
        echo "  (brak skonfigurowanych)"
        echo ""
        echo "Dodaj klaster: ocp-login --add"
        return
    fi

    for cluster in "$KUBE_CLUSTERS_DIR"/*; do
        if [[ -f "$cluster" ]]; then
            local name=$(basename "$cluster")
            local status=$(__check_token_validity "$cluster")

            local marker="  "
            [[ "$KUBECONFIG" == "$cluster" ]] && marker="* "

            case "$status" in
                valid)    echo -e "${marker}$name  \033[0;32m[OK]\033[0m" ;;
                expired)  echo -e "${marker}$name  \033[0;31m[WYGAS≈Å]\033[0m" ;;
                *)        echo -e "${marker}$name  \033[0;90m[?]\033[0m" ;;
            esac
        fi
    done

    echo ""
    echo "Aktualny: $(basename "${KUBECONFIG:-brak}" 2>/dev/null)"
}

ocp() {
    if [[ -z "$1" ]]; then
        ocp-list
        return
    fi

    local cluster_name="$1"
    local cluster_file="$KUBE_CLUSTERS_DIR/$cluster_name"

    if [[ ! -f "$cluster_file" ]]; then
        echo -e "\033[0;31mKlaster '$cluster_name' nie istnieje\033[0m"
        ocp-list
        return 1
    fi

    # Sprawd≈∫ status tokenu PRZED prze≈ÇƒÖczeniem
    local token_status=$(__check_token_validity "$cluster_file")

    export KUBECONFIG="$cluster_file"
    echo -e "\033[0;32mPrze≈ÇƒÖczono na: $cluster_name\033[0m"

    # Je≈õli token wygas≈Ç - uruchom auto-login przez ocp-switch
    if [[ "$token_status" == "expired" || "$token_status" == "no-token" ]]; then
        echo -e "\033[0;33mToken wygas≈Ç - pr√≥ba automatycznego logowania...\033[0m"

        if command -v ocp-login &> /dev/null; then
            ocp-login "$cluster_name"
        elif [[ -f "$OCP_TOOLS_DIR/bin/ocp-login" ]]; then
            "$OCP_TOOLS_DIR/bin/ocp-login" "$cluster_name"
        else
            echo -e "\033[0;31mNie znaleziono ocp-login. Zaloguj siƒô rƒôcznie.\033[0m"
            return 1
        fi
    else
        # Token OK - poka≈º info
        local user=$(oc whoami 2>/dev/null)
        if [[ -n "$user" ]]; then
            echo -e "  User: \033[0;32m$user\033[0m"
        fi
    fi

    # Ostrze≈ºenie dla produkcji
    if [[ "$cluster_name" == *prod* ]]; then
        echo -e "\033[0;31m‚ö†Ô∏è  UWAGA: ≈örodowisko PRODUKCYJNE!\033[0m"
    fi
}

# ============================================
# FUNKCJA SPRAWDZANIA WSZYSTKICH TOKEN√ìW
# ============================================

ocp-check() {
    echo -e "\033[0;34m=== Status token√≥w dla wszystkich klastr√≥w ===\033[0m"
    echo ""

    if [[ ! -d "$KUBE_CLUSTERS_DIR" ]] || [[ -z "$(ls -A "$KUBE_CLUSTERS_DIR" 2>/dev/null)" ]]; then
        echo "Brak skonfigurowanych klastr√≥w."
        return
    fi

    local expired_count=0
    local valid_count=0

    for cluster in "$KUBE_CLUSTERS_DIR"/*; do
        if [[ -f "$cluster" ]]; then
            local name=$(basename "$cluster")
            local status=$(__check_token_validity "$cluster")
            local api=$(grep "server:" "$cluster" 2>/dev/null | head -1 | awk '{print $2}')

            case "$status" in
                valid)
                    echo -e "\033[0;32m[OK]\033[0m      $name"
                    echo -e "          API: $api"
                    ((valid_count++))
                    ;;
                expired)
                    echo -e "\033[0;31m[WYGAS≈Å]\033[0m  $name"
                    echo -e "          API: $api"
                    echo -e "          \033[0;33m‚Üí U≈ºyj: ocp-login $name\033[0m"
                    ((expired_count++))
                    ;;
                no-token)
                    echo -e "\033[0;33m[BRAK]\033[0m    $name"
                    echo -e "          API: $api"
                    echo -e "          \033[0;33m‚Üí Brak tokenu w kubeconfig\033[0m"
                    ((expired_count++))
                    ;;
                *)
                    echo -e "\033[0;90m[?]\033[0m       $name"
                    echo -e "          API: $api"
                    ;;
            esac
            echo ""
        fi
    done

    echo "---"
    echo -e "Podsumowanie: \033[0;32m$valid_count OK\033[0m, \033[0;31m$expired_count wymaga uwagi\033[0m"

    if [[ $expired_count -gt 0 ]]; then
        echo ""
        echo -e "\033[0;33mWskaz√≥wka: Aby odnowiƒá tokeny, u≈ºyj ocp-login [nazwa-klastra]\033[0m"
    fi
}

# ============================================
# KOMUNIKAT AKTYWACJI
# ============================================

echo ""
echo -e "\033[0;32m‚úì ≈örodowisko OpenShift aktywowane\033[0m"
echo ""
echo "Komendy:"
echo "  ocp [klaster]    - prze≈ÇƒÖcz klaster (lub lista)"
echo "  ocp-current      - poka≈º aktualny kontekst"
echo "  ocp-check        - sprawd≈∫ wa≈ºno≈õƒá wszystkich token√≥w"
echo "  ocp-deactivate   - dezaktywuj ≈õrodowisko"
echo ""
echo "Aliasy: kprod1, kprod2, kstg, kdev, ktest"

# Ostrze≈ºenie o domy≈õlnym KUBECONFIG
if [[ -n "$_OCP_OLD_KUBECONFIG" && "$_OCP_OLD_KUBECONFIG" == "$HOME/.kube/config" ]]; then
    echo ""
    echo -e "\033[0;33m‚ö† Poprzednio u≈ºywa≈Çe≈õ domy≈õlnego ~/.kube/config\033[0m"
    echo -e "  Zalecane: u≈ºyj dedykowanych plik√≥w z ~/.kube/clusters/"
fi

echo ""

# Je≈õli podano argument, prze≈ÇƒÖcz na klaster
if [[ -n "$1" ]]; then
    ocp "$1"
fi
