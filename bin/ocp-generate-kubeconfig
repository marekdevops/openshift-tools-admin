#!/bin/bash
#
# ocp-generate-kubeconfig - Generowanie pliku kubeconfig z tokenem SA
# Użycie: ocp-generate-kubeconfig [nazwa-klastra] [api-url] [token]
#

KUBE_DIR="${KUBE_CLUSTERS_DIR:-$HOME/.kube/clusters}"

# Kolory
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    echo "Generowanie pliku kubeconfig dla klastra OpenShift"
    echo ""
    echo "Użycie: ocp-generate-kubeconfig [nazwa] [api-url] [token]"
    echo ""
    echo "Argumenty:"
    echo "  nazwa    - Nazwa klastra (np. prod-cluster1)"
    echo "  api-url  - URL API klastra (np. https://api.cluster.example.com:6443)"
    echo "  token    - Token ServiceAccount (opcjonalnie - można podać interaktywnie)"
    echo ""
    echo "Przykład:"
    echo "  ocp-generate-kubeconfig prod-cluster1 https://api.prod.example.com:6443"
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    show_help
    exit 0
fi

CLUSTER_NAME="${1:-}"
API_URL="${2:-}"
TOKEN="${3:-}"

# Interaktywne pobieranie danych jeśli nie podano
if [[ -z "$CLUSTER_NAME" ]]; then
    read -p "Nazwa klastra: " CLUSTER_NAME
fi

if [[ -z "$API_URL" ]]; then
    read -p "API URL (https://api.xxx:6443): " API_URL
fi

if [[ -z "$TOKEN" ]]; then
    echo "Token (wklej i naciśnij Enter):"
    read -s TOKEN
    echo ""
fi

# Walidacja
if [[ -z "$CLUSTER_NAME" || -z "$API_URL" || -z "$TOKEN" ]]; then
    echo -e "${RED}Błąd: Wszystkie parametry są wymagane${NC}"
    show_help
    exit 1
fi

# Utwórz katalog
mkdir -p "$KUBE_DIR"

# Ścieżka do pliku
KUBECONFIG_FILE="$KUBE_DIR/$CLUSTER_NAME"

echo -e "${BLUE}Generowanie kubeconfig dla: $CLUSTER_NAME${NC}"
echo ""

# Pobierz CA certificate (opcjonalne)
echo "Czy chcesz pobrać certyfikat CA z klastra? (wymaga dostępu do API)"
read -p "(t/n, domyślnie n): " GET_CA

CA_DATA=""
if [[ "$GET_CA" == "t" ]]; then
    echo "Pobieranie certyfikatu CA..."
    # Próba pobrania CA z klastra
    CA_DATA=$(curl -sk "$API_URL/.well-known/oauth-authorization-server" 2>/dev/null | grep -o '"issuer":"[^"]*"' | head -1)

    if [[ -z "$CA_DATA" ]]; then
        echo -e "${YELLOW}Nie udało się pobrać CA, używam insecure-skip-tls-verify${NC}"
    fi
fi

# Generuj kubeconfig
cat > "$KUBECONFIG_FILE" <<EOF
apiVersion: v1
kind: Config
preferences: {}

clusters:
- cluster:
    server: ${API_URL}
    insecure-skip-tls-verify: true
  name: ${CLUSTER_NAME}

contexts:
- context:
    cluster: ${CLUSTER_NAME}
    user: ${CLUSTER_NAME}-admin
    namespace: default
  name: ${CLUSTER_NAME}

current-context: ${CLUSTER_NAME}

users:
- name: ${CLUSTER_NAME}-admin
  user:
    token: ${TOKEN}
EOF

# Ustaw odpowiednie uprawnienia
chmod 600 "$KUBECONFIG_FILE"

echo -e "${GREEN}Kubeconfig wygenerowany: $KUBECONFIG_FILE${NC}"
echo ""

# Testuj połączenie
echo "Testuję połączenie..."
if KUBECONFIG="$KUBECONFIG_FILE" oc whoami &>/dev/null; then
    USER=$(KUBECONFIG="$KUBECONFIG_FILE" oc whoami)
    echo -e "${GREEN}Połączenie OK! Zalogowany jako: $USER${NC}"
else
    echo -e "${YELLOW}Uwaga: Nie można zweryfikować połączenia${NC}"
    echo "Sprawdź czy token jest poprawny i czy masz dostęp sieciowy do klastra"
fi

echo ""
echo -e "${BLUE}Jak używać:${NC}"
echo "  export KUBECONFIG=$KUBECONFIG_FILE"
echo "  # lub"
echo "  source ocp-switch $CLUSTER_NAME"
