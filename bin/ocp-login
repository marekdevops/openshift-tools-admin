#!/bin/bash
#
# ocp-login - Skrypt do logowania do klastrów OpenShift
# Użycie: ocp-login [nazwa-klastra]
#

KUBE_DIR="${KUBE_CLUSTERS_DIR:-$HOME/.kube/clusters}"
TOKENS_DIR="${KUBE_TOKENS_DIR:-$HOME/.kube/tokens}"
CLUSTER_CONFIG="$HOME/.kube/cluster-registry.conf"

# Kolory
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# ===========================================
# OCHRONA: Blokada domyślnego ~/.kube/config
# ===========================================
_protect_default_kubeconfig() {
    local default_config="$HOME/.kube/config"

    # Jeśli domyślny config nie istnieje lub jest pusty, utwórz "blokadę"
    if [[ ! -f "$default_config" ]] || [[ ! -s "$default_config" ]]; then
        mkdir -p "$HOME/.kube"
        cat > "$default_config" <<'BLOCK'
# UWAGA: Ten plik jest celowo pusty!
# Używaj dedykowanych plików kubeconfig z ~/.kube/clusters/
# NIE loguj się bez --kubeconfig!
apiVersion: v1
kind: Config
preferences: {}
clusters: null
contexts: null
users: null
current-context: ""
BLOCK
        chmod 600 "$default_config"
    fi
}

# Walidacja spójności: token vs API URL w istniejącym kubeconfig
_validate_kubeconfig_consistency() {
    local cluster_name="$1"
    local expected_api="$2"
    local cluster_file="$KUBE_DIR/$cluster_name"

    if [[ -f "$cluster_file" ]]; then
        local current_api=$(grep -A2 "^clusters:" "$cluster_file" 2>/dev/null | grep "server:" | awk '{print $2}')

        if [[ -n "$current_api" && "$current_api" != "$expected_api" ]]; then
            echo -e "${RED}OSTRZEŻENIE: Niespójność API URL!${NC}"
            echo -e "  Zapisany w kubeconfig: ${YELLOW}$current_api${NC}"
            echo -e "  Oczekiwany z rejestru: ${YELLOW}$expected_api${NC}"
            echo ""
            read -p "Czy nadpisać kubeconfig nowym API URL? (t/n): " overwrite
            if [[ "$overwrite" != "t" ]]; then
                echo -e "${YELLOW}Anulowano. Sprawdź konfigurację ręcznie.${NC}"
                return 1
            fi
        fi
    fi
    return 0
}

show_help() {
    echo "Użycie: ocp-login [OPCJE] [nazwa-klastra]"
    echo ""
    echo "Opcje:"
    echo "  -a, --add      Dodaj nowy klaster do rejestru"
    echo "  -l, --list     Pokaż zarejestrowane klastry"
    echo "  -h, --help     Pokaż tę pomoc"
    echo ""
    echo "Przykłady:"
    echo "  ocp-login prod-cluster1"
    echo "  ocp-login --add"
}

# Ładowanie konfiguracji klastrów
load_cluster_config() {
    if [[ -f "$CLUSTER_CONFIG" ]]; then
        source "$CLUSTER_CONFIG"
    fi
}

# Zapisywanie konfiguracji klastrów
save_cluster_config() {
    local name="$1"
    local api="$2"

    echo "CLUSTER_API_${name//-/_}=\"$api\"" >> "$CLUSTER_CONFIG"
}

# Pobierz API URL dla klastra
get_cluster_api() {
    local name="$1"
    local var_name="CLUSTER_API_${name//-/_}"
    echo "${!var_name}"
}

# Dodaj nowy klaster
add_cluster() {
    echo -e "${BLUE}Dodawanie nowego klastra${NC}"
    echo ""

    read -p "Nazwa klastra (np. prod-cluster1): " cluster_name
    read -p "API URL (np. https://api.cluster.example.com:6443): " cluster_api

    if [[ -z "$cluster_name" || -z "$cluster_api" ]]; then
        echo -e "${RED}Błąd: Nazwa i API URL są wymagane${NC}"
        return 1
    fi

    save_cluster_config "$cluster_name" "$cluster_api"
    echo -e "${GREEN}Klaster '$cluster_name' został dodany${NC}"
    echo ""
    echo "Teraz możesz zalogować się: ocp-login $cluster_name"
}

# Lista zarejestrowanych klastrów
list_clusters() {
    echo -e "${BLUE}Zarejestrowane klastry:${NC}"
    echo ""

    if [[ -f "$CLUSTER_CONFIG" ]]; then
        grep "^CLUSTER_API_" "$CLUSTER_CONFIG" | while read line; do
            name=$(echo "$line" | sed 's/CLUSTER_API_//' | cut -d'=' -f1 | tr '_' '-')
            api=$(echo "$line" | cut -d'=' -f2 | tr -d '"')
            echo "  $name -> $api"
        done
    else
        echo "  Brak zarejestrowanych klastrów. Użyj: ocp-login --add"
    fi
}

# Logowanie do klastra
login_cluster() {
    local cluster_name="$1"
    local cluster_file="$KUBE_DIR/$cluster_name"
    local token_file="$TOKENS_DIR/$cluster_name"

    # Ochrona przed przypadkowym nadpisaniem domyślnego config
    _protect_default_kubeconfig

    load_cluster_config

    # Pobierz API URL
    local api_url=$(get_cluster_api "$cluster_name")

    if [[ -z "$api_url" ]]; then
        echo -e "${YELLOW}Klaster '$cluster_name' nie jest zarejestrowany.${NC}"
        read -p "Podaj API URL: " api_url

        if [[ -z "$api_url" ]]; then
            echo -e "${RED}API URL jest wymagany${NC}"
            return 1
        fi

        read -p "Zapisać ten klaster? (t/n): " save_choice
        if [[ "$save_choice" == "t" ]]; then
            save_cluster_config "$cluster_name" "$api_url"
        fi
    fi

    # Walidacja spójności istniejącego kubeconfig
    if ! _validate_kubeconfig_consistency "$cluster_name" "$api_url"; then
        return 1
    fi

    # Sprawdź czy mamy zapisany token
    local token=""
    if [[ -f "$token_file" ]]; then
        token=$(cat "$token_file")
        echo -e "${BLUE}Używam zapisanego tokena z $token_file${NC}"

        # Walidacja czy token działa z tym API
        echo -e "${CYAN}Weryfikacja tokena...${NC}"
        local test_result=$(curl -sk -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $token" \
            "$api_url/apis" 2>/dev/null)

        if [[ "$test_result" == "401" || "$test_result" == "403" ]]; then
            echo -e "${YELLOW}Token wygasł lub jest nieprawidłowy dla tego klastra.${NC}"
            read -p "Podać nowy token? (t/n): " new_token_choice
            if [[ "$new_token_choice" == "t" ]]; then
                echo "Podaj token (możesz go uzyskać z: oc whoami -t)"
                read -sp "Token: " token
                echo ""

                if [[ -n "$token" ]]; then
                    echo "$token" > "$token_file"
                    chmod 600 "$token_file"
                    echo -e "${GREEN}Nowy token zapisany${NC}"
                fi
            else
                echo -e "${RED}Anulowano - token jest wymagany${NC}"
                return 1
            fi
        elif [[ "$test_result" == "000" ]]; then
            echo -e "${YELLOW}Nie można połączyć z API ($api_url)${NC}"
            echo "Sprawdź połączenie sieciowe."
        else
            echo -e "${GREEN}Token wygląda na prawidłowy (HTTP $test_result)${NC}"
        fi
    else
        echo -e "${YELLOW}Brak zapisanego tokena.${NC}"
        echo "Podaj token (możesz go uzyskać z: oc whoami -t)"
        read -sp "Token: " token
        echo ""

        if [[ -z "$token" ]]; then
            echo -e "${RED}Token jest wymagany${NC}"
            return 1
        fi

        read -p "Zapisać token do $token_file? (t/n): " save_token
        if [[ "$save_token" == "t" ]]; then
            mkdir -p "$TOKENS_DIR"
            chmod 700 "$TOKENS_DIR"
            echo "$token" > "$token_file"
            chmod 600 "$token_file"
            echo -e "${GREEN}Token zapisany${NC}"
        fi
    fi

    # Utwórz katalog na kubeconfig
    mkdir -p "$KUBE_DIR"

    # Logowanie
    echo -e "${BLUE}Logowanie do $cluster_name...${NC}"

    oc login "$api_url" \
        --token="$token" \
        --kubeconfig="$cluster_file" \
        --insecure-skip-tls-verify=false

    if [[ $? -eq 0 ]]; then
        echo ""
        echo -e "${GREEN}Zalogowano pomyślnie!${NC}"
        echo ""
        echo "Aby przełączyć się na ten klaster, użyj:"
        echo "  source ocp-switch $cluster_name"
        echo ""
        echo "Lub dodaj do ~/.bashrc:"
        echo "  alias k${cluster_name//-/}='export KUBECONFIG=$cluster_file'"
    else
        echo -e "${RED}Błąd logowania${NC}"
        return 1
    fi
}

# Upewnij się, że katalogi istnieją
mkdir -p "$KUBE_DIR" "$TOKENS_DIR"
chmod 700 "$TOKENS_DIR"

# Parsowanie argumentów
case "${1:-}" in
    -h|--help)
        show_help
        ;;
    -a|--add)
        add_cluster
        ;;
    -l|--list)
        list_clusters
        ;;
    "")
        show_help
        ;;
    *)
        login_cluster "$1"
        ;;
esac
