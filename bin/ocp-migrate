#!/bin/bash
#
# ocp-migrate - Migracja i naprawa konfiguracji kubeconfig
#
# Ten skrypt:
# - Migruje konfigi z ~/.kube/config do ~/.kube/clusters/
# - Waliduje spójność tokenów z API URL
# - Naprawia uszkodzone/mieszane konfiguracje
# - NIE wymaga rekreacji tokenów (o ile są nadal ważne)
#

KUBE_DIR="${KUBE_CLUSTERS_DIR:-$HOME/.kube/clusters}"
TOKENS_DIR="${KUBE_TOKENS_DIR:-$HOME/.kube/tokens}"
DEFAULT_CONFIG="$HOME/.kube/config"
BACKUP_DIR="$HOME/.kube/backup-$(date +%Y%m%d-%H%M%S)"

# Kolory
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

show_help() {
    echo "ocp-migrate - Migracja i naprawa konfiguracji kubeconfig"
    echo ""
    echo "Użycie: ocp-migrate [OPCJA]"
    echo ""
    echo "Opcje:"
    echo "  --analyze       Analiza bez zmian (domyślne)"
    echo "  --migrate       Migruj konteksty z ~/.kube/config do ~/.kube/clusters/"
    echo "  --fix           Napraw niespójne konfiguracje"
    echo "  --protect       Zablokuj domyślny ~/.kube/config"
    echo "  --backup        Utwórz backup wszystkich konfiguracji"
    echo "  -h, --help      Pokaż tę pomoc"
    echo ""
    echo "Przykłady:"
    echo "  ocp-migrate --analyze    # Zobacz co wymaga naprawy"
    echo "  ocp-migrate --migrate    # Przenieś konfigi"
    echo "  ocp-migrate --protect    # Zablokuj domyślny config"
}

# Sprawdź czy token jest ważny (uproszczona wersja)
check_token() {
    local token="$1"

    if [[ -z "$token" ]]; then
        echo "no-token"
        return
    fi

    # JWT check
    if [[ "$token" =~ ^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$ ]]; then
        local payload=$(echo "$token" | cut -d. -f2 | base64 -d 2>/dev/null)
        local exp=$(echo "$payload" | grep -o '"exp":[0-9]*' 2>/dev/null | cut -d: -f2)

        if [[ -n "$exp" ]]; then
            local now=$(date +%s)
            if [[ $exp -lt $now ]]; then
                echo "expired"
                return
            fi
            echo "valid-jwt"
            return
        fi
    fi

    # Prawdopodobnie token SA (nie wygasa)
    echo "valid-sa"
}

# Analiza konfiguracji
analyze() {
    echo -e "${BLUE}=== Analiza konfiguracji ===${NC}"
    echo ""

    # Sprawdź domyślny config
    echo -e "${CYAN}1. Domyślny ~/.kube/config:${NC}"
    if [[ -f "$DEFAULT_CONFIG" ]]; then
        local contexts=$(grep "^- context:" "$DEFAULT_CONFIG" 2>/dev/null | wc -l)
        local current=$(grep "^current-context:" "$DEFAULT_CONFIG" 2>/dev/null | awk '{print $2}')

        if [[ $contexts -gt 0 ]]; then
            echo -e "   ${YELLOW}Zawiera $contexts kontekst(ów)${NC}"
            echo "   Current: ${current:-brak}"

            # Lista kontekstów
            echo "   Konteksty:"
            grep -A3 "^- context:" "$DEFAULT_CONFIG" 2>/dev/null | grep "name:" | while read line; do
                name=$(echo "$line" | awk '{print $2}')
                echo "     - $name"
            done

            echo ""
            echo -e "   ${YELLOW}→ Zalecane: migracja do ~/.kube/clusters/${NC}"
        else
            echo -e "   ${GREEN}Pusty/zablokowany - OK${NC}"
        fi
    else
        echo -e "   ${GREEN}Nie istnieje - OK${NC}"
    fi

    echo ""

    # Sprawdź katalog clusters
    echo -e "${CYAN}2. Katalog ~/.kube/clusters/:${NC}"
    if [[ -d "$KUBE_DIR" ]] && [[ -n "$(ls -A "$KUBE_DIR" 2>/dev/null)" ]]; then
        local count=$(ls -1 "$KUBE_DIR" 2>/dev/null | wc -l)
        echo "   Znaleziono $count konfiguracji:"
        echo ""

        for cluster in "$KUBE_DIR"/*; do
            if [[ -f "$cluster" ]]; then
                local name=$(basename "$cluster")
                local api=$(grep "server:" "$cluster" 2>/dev/null | head -1 | awk '{print $2}')
                local token=$(grep "token:" "$cluster" 2>/dev/null | head -1 | awk '{print $2}')
                local token_status=$(check_token "$token")

                echo -n "   $name"
                echo -n " → $api"

                case "$token_status" in
                    valid-jwt) echo -e " ${GREEN}[JWT OK]${NC}" ;;
                    valid-sa)  echo -e " ${GREEN}[SA OK]${NC}" ;;
                    expired)   echo -e " ${RED}[WYGASŁ]${NC}" ;;
                    no-token)  echo -e " ${YELLOW}[BRAK TOKENU]${NC}" ;;
                esac
            fi
        done
    else
        echo -e "   ${YELLOW}Pusty - brak skonfigurowanych klastrów${NC}"
    fi

    echo ""

    # Sprawdź katalog tokens
    echo -e "${CYAN}3. Katalog ~/.kube/tokens/:${NC}"
    if [[ -d "$TOKENS_DIR" ]] && [[ -n "$(ls -A "$TOKENS_DIR" 2>/dev/null)" ]]; then
        local count=$(ls -1 "$TOKENS_DIR" 2>/dev/null | wc -l)
        echo "   Znaleziono $count zapisanych tokenów"

        for token_file in "$TOKENS_DIR"/*; do
            if [[ -f "$token_file" ]]; then
                local name=$(basename "$token_file")
                local token=$(cat "$token_file")
                local token_status=$(check_token "$token")

                echo -n "   $name: "
                case "$token_status" in
                    valid-jwt) echo -e "${GREEN}JWT OK${NC}" ;;
                    valid-sa)  echo -e "${GREEN}SA (nie wygasa)${NC}" ;;
                    expired)   echo -e "${RED}WYGASŁ${NC}" ;;
                    no-token)  echo -e "${YELLOW}pusty${NC}" ;;
                esac
            fi
        done
    else
        echo "   (pusty)"
    fi

    echo ""

    # Sprawdź cluster-registry.conf
    echo -e "${CYAN}4. Rejestr klastrów (~/.kube/cluster-registry.conf):${NC}"
    if [[ -f "$HOME/.kube/cluster-registry.conf" ]]; then
        local entries=$(grep "^CLUSTER_API_" "$HOME/.kube/cluster-registry.conf" 2>/dev/null | wc -l)
        echo "   Zarejestrowanych: $entries"

        grep "^CLUSTER_API_" "$HOME/.kube/cluster-registry.conf" 2>/dev/null | while read line; do
            name=$(echo "$line" | sed 's/CLUSTER_API_//' | cut -d'=' -f1 | tr '_' '-')
            api=$(echo "$line" | cut -d'=' -f2 | tr -d '"')
            echo "   $name → $api"
        done
    else
        echo "   (nie istnieje)"
    fi

    echo ""
    echo -e "${BLUE}=== Rekomendacje ===${NC}"

    local has_issues=0

    # Sprawdź czy domyślny config ma konteksty
    if [[ -f "$DEFAULT_CONFIG" ]]; then
        local contexts=$(grep "^- context:" "$DEFAULT_CONFIG" 2>/dev/null | wc -l)
        if [[ $contexts -gt 0 ]]; then
            echo -e "  ${YELLOW}→ Uruchom: ocp-migrate --migrate${NC}"
            has_issues=1
        fi
    fi

    # Sprawdź wygasłe tokeny
    if [[ -d "$KUBE_DIR" ]]; then
        for cluster in "$KUBE_DIR"/*; do
            if [[ -f "$cluster" ]]; then
                local token=$(grep "token:" "$cluster" 2>/dev/null | head -1 | awk '{print $2}')
                if [[ $(check_token "$token") == "expired" ]]; then
                    local name=$(basename "$cluster")
                    echo -e "  ${YELLOW}→ Odnów token dla: $name (ocp-login $name)${NC}"
                    has_issues=1
                fi
            fi
        done
    fi

    if [[ $has_issues -eq 0 ]]; then
        echo -e "  ${GREEN}Wszystko wygląda OK!${NC}"
    fi
}

# Migracja z domyślnego config
migrate() {
    echo -e "${BLUE}=== Migracja kontekstów ===${NC}"
    echo ""

    if [[ ! -f "$DEFAULT_CONFIG" ]]; then
        echo -e "${GREEN}Brak ~/.kube/config - nic do migracji${NC}"
        return 0
    fi

    local contexts=$(grep "^- context:" "$DEFAULT_CONFIG" 2>/dev/null | wc -l)
    if [[ $contexts -eq 0 ]]; then
        echo -e "${GREEN}Domyślny config jest pusty - nic do migracji${NC}"
        return 0
    fi

    # Backup
    echo -e "${CYAN}Tworzenie backupu...${NC}"
    mkdir -p "$BACKUP_DIR"
    cp "$DEFAULT_CONFIG" "$BACKUP_DIR/config"
    echo "Backup: $BACKUP_DIR/config"
    echo ""

    # Utwórz katalogi
    mkdir -p "$KUBE_DIR" "$TOKENS_DIR"
    chmod 700 "$TOKENS_DIR"

    echo -e "${CYAN}Ekstrakcja kontekstów...${NC}"
    echo ""

    # Pobierz listę kontekstów
    local context_names=$(grep "^  name:" "$DEFAULT_CONFIG" 2>/dev/null | awk '{print $2}' | sort -u)

    for ctx_name in $context_names; do
        echo -e "${YELLOW}Przetwarzanie: $ctx_name${NC}"

        # Pobierz dane kontekstu
        local cluster_name=$(grep -A5 "^- context:" "$DEFAULT_CONFIG" | grep -A5 "name: $ctx_name" | grep "cluster:" | head -1 | awk '{print $2}')
        local user_name=$(grep -A5 "^- context:" "$DEFAULT_CONFIG" | grep -A5 "name: $ctx_name" | grep "user:" | head -1 | awk '{print $2}')

        # Pobierz dane klastra
        local server=$(grep -A5 "^- cluster:" "$DEFAULT_CONFIG" | grep -A5 "name: $cluster_name" | grep "server:" | head -1 | awk '{print $2}')

        # Pobierz token
        local token=$(grep -A5 "^- name: $user_name" "$DEFAULT_CONFIG" | grep "token:" | head -1 | awk '{print $2}')

        if [[ -z "$server" ]]; then
            echo -e "  ${RED}Brak API URL - pomijam${NC}"
            continue
        fi

        # Utwórz dedykowany kubeconfig
        local cluster_file="$KUBE_DIR/$ctx_name"

        if [[ -f "$cluster_file" ]]; then
            echo -e "  ${YELLOW}Plik już istnieje - pomijam${NC}"
            continue
        fi

        cat > "$cluster_file" <<EOF
apiVersion: v1
kind: Config
preferences: {}

clusters:
- cluster:
    server: ${server}
    insecure-skip-tls-verify: true
  name: ${ctx_name}

contexts:
- context:
    cluster: ${ctx_name}
    user: ${ctx_name}-admin
    namespace: default
  name: ${ctx_name}

current-context: ${ctx_name}

users:
- name: ${ctx_name}-admin
  user:
    token: ${token}
EOF

        chmod 600 "$cluster_file"
        echo -e "  ${GREEN}Utworzono: $cluster_file${NC}"

        # Zapisz token osobno
        if [[ -n "$token" ]]; then
            echo "$token" > "$TOKENS_DIR/$ctx_name"
            chmod 600 "$TOKENS_DIR/$ctx_name"
            echo -e "  Token zapisany do: $TOKENS_DIR/$ctx_name"
        fi

        echo ""
    done

    echo -e "${GREEN}Migracja zakończona!${NC}"
    echo ""
    echo "Następne kroki:"
    echo "  1. Sprawdź: ocp-migrate --analyze"
    echo "  2. Zablokuj domyślny config: ocp-migrate --protect"
}

# Zablokuj domyślny config
protect() {
    echo -e "${BLUE}=== Blokowanie domyślnego ~/.kube/config ===${NC}"
    echo ""

    # Backup jeśli ma zawartość
    if [[ -f "$DEFAULT_CONFIG" ]]; then
        local contexts=$(grep "^- context:" "$DEFAULT_CONFIG" 2>/dev/null | wc -l)
        if [[ $contexts -gt 0 ]]; then
            echo -e "${YELLOW}UWAGA: Domyślny config zawiera $contexts kontekst(ów)!${NC}"
            read -p "Czy najpierw przeprowadzić migrację? (t/n): " do_migrate
            if [[ "$do_migrate" == "t" ]]; then
                migrate
            fi

            read -p "Czy nadpisać domyślny config blokadą? (t/n): " confirm
            if [[ "$confirm" != "t" ]]; then
                echo "Anulowano."
                return 1
            fi

            # Backup
            mkdir -p "$BACKUP_DIR"
            cp "$DEFAULT_CONFIG" "$BACKUP_DIR/config"
            echo "Backup: $BACKUP_DIR/config"
        fi
    fi

    mkdir -p "$HOME/.kube"
    cat > "$DEFAULT_CONFIG" <<'EOF'
# ============================================
# UWAGA: Ten plik jest celowo zablokowany!
# ============================================
#
# NIE używaj domyślnego ~/.kube/config!
# Używaj dedykowanych plików z ~/.kube/clusters/
#
# Prawidłowe użycie:
#   source ocp-activate [klaster]
#   ocp-switch [klaster]
#   export KUBECONFIG=~/.kube/clusters/[klaster]
#
# Jeśli widzisz błędy "system:anonymous" to znaczy,
# że KUBECONFIG nie jest ustawiony i oc używa tego pliku.
#
apiVersion: v1
kind: Config
preferences: {}
clusters: null
contexts: null
users: null
current-context: ""
EOF

    chmod 600 "$DEFAULT_CONFIG"

    echo -e "${GREEN}Domyślny config zablokowany!${NC}"
    echo ""
    echo "Od teraz każde 'oc login' bez --kubeconfig pokaże błąd,"
    echo "co pomoże wykryć przypadkowe nadpisanie."
}

# Backup
backup() {
    echo -e "${BLUE}=== Tworzenie backupu ===${NC}"
    echo ""

    mkdir -p "$BACKUP_DIR"

    if [[ -f "$DEFAULT_CONFIG" ]]; then
        cp "$DEFAULT_CONFIG" "$BACKUP_DIR/config"
        echo "  ~/.kube/config → $BACKUP_DIR/config"
    fi

    if [[ -d "$KUBE_DIR" ]]; then
        cp -r "$KUBE_DIR" "$BACKUP_DIR/clusters"
        echo "  ~/.kube/clusters/ → $BACKUP_DIR/clusters/"
    fi

    if [[ -d "$TOKENS_DIR" ]]; then
        cp -r "$TOKENS_DIR" "$BACKUP_DIR/tokens"
        echo "  ~/.kube/tokens/ → $BACKUP_DIR/tokens/"
    fi

    if [[ -f "$HOME/.kube/cluster-registry.conf" ]]; then
        cp "$HOME/.kube/cluster-registry.conf" "$BACKUP_DIR/"
        echo "  cluster-registry.conf → $BACKUP_DIR/"
    fi

    echo ""
    echo -e "${GREEN}Backup utworzony: $BACKUP_DIR${NC}"
}

# Parsowanie argumentów
case "${1:-}" in
    -h|--help)
        show_help
        ;;
    --migrate)
        migrate
        ;;
    --protect)
        protect
        ;;
    --backup)
        backup
        ;;
    --fix)
        echo "Funkcja naprawy - TODO"
        echo "Na razie użyj: --migrate i --protect"
        ;;
    --analyze|"")
        analyze
        ;;
    *)
        echo -e "${RED}Nieznana opcja: $1${NC}"
        show_help
        exit 1
        ;;
esac
